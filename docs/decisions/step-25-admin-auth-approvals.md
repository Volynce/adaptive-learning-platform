\# Step-25: Admin JWT + approvals (rank\_transition)



Проект: adaptive-learning-platform  

Этап: step-25-admin-auth-approvals  

Цель: добавить административный контур для подтверждения межранговых переходов (approval\_requests) с отдельной аутентификацией администратора и строгим разграничением прав доступа.



\## 1) Зафиксированные решения



\### 1.1. Администратор — отдельная сущность и отдельный логин

\- Администратор хранится в таблице `admin\_users` (не в `users`).

\- Для админа реализован отдельный endpoint:

&nbsp; - `POST /api/v1/admin/login` → выдача JWT access-only.



Причина: разделение контуров безопасности и исключение смешивания сценариев user/auth и admin/auth.



\### 1.2. Разделение токенов через claim `scope`

\- При выпуске JWT добавлен claim:

&nbsp; - `scope="user"` для обычного пользователя (по умолчанию),

&nbsp; - `scope="admin"` для администратора.

\- `type` токена фиксирован как `"access"` (учебный стенд, без refresh).



Причина: запрет эскалации привилегий. Даже корректный user JWT не может быть принят как admin JWT.



\### 1.3. Централизованная проверка админского JWT

\- В `api/deps.py` добавлен dependency `current\_admin\_id`:

&nbsp; - извлекает Bearer token,

&nbsp; - декодирует,

&nbsp; - проверяет `payload\["type"] == "access"`,

&nbsp; - проверяет `payload\["scope"] == "admin"`,

&nbsp; - возвращает `int(payload\["sub"])`.

\- При ошибке возвращается HTTP 401.



Причина: единый контур проверки для всех `/api/v1/admin/\*` endpoints; отсутствие дублирования логики.



\### 1.4. Подтверждение перехода выполняется атомарно

\- Реализованы endpoints:

&nbsp; - `GET /api/v1/admin/approvals/pending` — список заявок `status='pending'`.

&nbsp; - `POST /api/v1/admin/approvals/{id}/approve` — approve заявки rank\_transition.

\- Approve реализован транзакционно:

&nbsp; - заявка переводится в `approved` только через `UPDATE ... WHERE status='pending'` (защита от двойного approve),

&nbsp; - после approve выполняется доменная операция перехода:

&nbsp;   - from\_stage фиксируется как завершённая,

&nbsp;   - to\_stage активируется как `active`.



Причина: сохранение инвариантов домена и защита от гонок при параллельных запросах.



\## 2) Изменения в данных / DDL



\### 2.1. Пароль администратора

\- Добавлено поле `admin\_users.password\_hash`.

\- Для стенда предусмотрен seed админа:

&nbsp; - `admin@example.com` / пароль стенда (пример): `AdminPassword123`.



Причина: админский логин требует проверки пароля по hash (как и user login).



\## 3) Инварианты и гарантии целостности



1\) Невозможность пользовательским токеном обратиться к admin endpoints:

&nbsp;  - enforced через `scope="admin"` и `current\_admin\_id`.

2\) Невозможность повторного approve одной заявки:

&nbsp;  - enforced через условный `UPDATE ... WHERE status='pending'`.

3\) Единственная активная стадия пользователя:

&nbsp;  - сохраняется правилами домена и ограничениями БД (unique active stage).



\## 4) Особенности тестирования на Windows/Git Bash (учебный стенд)

\- При отправке JSON body с кириллицей через `curl -d '{...}'` возможна ошибка парсинга тела запроса.

\- Рекомендованный способ: формировать payload через `python json.dumps()` (ASCII/Unicode escape), либо отправлять `{}` и комментарий добавлять позже.



Примечание: это относится только к тестовому инструменту (curl/кодировки), а не к доменной логике.



\## 5) Откат и воспроизводимость

\- Все изменения шага фиксируются отдельной веткой `step-25-admin-auth-approvals` и тегом `step-25`.

\- Откат возможен через `git reset --hard` и `alembic downgrade` на одну ревизию при необходимости.

